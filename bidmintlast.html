<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFT Minting Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@0.5.24/dist/vanta.net.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    body {
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }
    #bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      width: 100%;
    }
    .logo-link {
      display: inline-block;
      margin-bottom: 10px;
    }
    .polygon-logo {
      width: 70px;
      height: auto;
      transition: transform 0.3s;
    }
    .polygon-logo:hover {
      transform: scale(1.1);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #00ffcc;
    }
    .container {
      width: 100%;
      max-width: 500px;
    }
    .card {
      background: rgba(0,0,0,0.7);
      border: 2px solid #00ffcc;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #00ffcc, #0099ff);
      color: #000;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid #00ffcc;
    }
    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      width: 30px;
      height: 30px;
      margin: 15px auto;
      border: 4px solid rgba(0,255,204,0.3);
      border-top: 4px solid #00ffcc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message {
      padding: 12px;
      margin: 15px 0;
      border-radius: 8px;
      display: none;
    }
    .error {
      background: rgba(255,50,50,0.2);
      border: 1px solid #ff3232;
      color: #ff6b6b;
    }
    .success {
      background: rgba(0,255,153,0.2);
      border: 1px solid #00ff99;
      color: #00ff99;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .stat-item {
      text-align: center;
      padding: 12px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      border: 1px solid #333;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #00ffcc;
    }
    .admin-panel {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed #00ffcc;
    }
    .wallet-info {
      margin-top: 15px;
      padding: 12px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      border: 1px solid #333;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="bg"></div>

  <header class="header">
    <a href="https://polygon.technology/" target="_blank" class="logo-link">
      <img src="https://polygon.technology/wp-content/uploads/2021/06/polygon-logo.png" 
           alt="Polygon Logo" class="polygon-logo">
    </a>
    <h1>NFT Minting Portal</h1>
  </header>

  <main class="container">
    <div class="card">
      <h2>Mint Your NFT</h2>
      <input type="number" id="bidAmount" placeholder="Enter amount in MATIC" step="0.01" min="0">
      <button id="bidButton" class="btn-primary">Submit Bid</button>
      <button id="mintButton" class="btn-primary" disabled>Mint NFT</button>
      <button id="withdrawButton" class="btn-secondary">Withdraw Bid</button>
      
      <div class="loading" id="loading"></div>
      <div class="message error" id="error"></div>
      <div class="message success" id="success"></div>
      
      <div class="stats">
        <div class="stat-item">
          <div>Total Minted</div>
          <div class="stat-value" id="totalMinted">0</div>
        </div>
        <div class="stat-item">
          <div>Max Supply</div>
          <div class="stat-value" id="maxSupply">0</div>
        </div>
        <div class="stat-item">
          <div>Your Balance</div>
          <div class="stat-value" id="userBalance">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Transaction Details</h2>
      <div>
        <div><strong>From:</strong> <span id="txFrom">-</span></div>
        <div><strong>To:</strong> <span id="txTo">-</span></div>
        <div><strong>Gas Used:</strong> <span id="txGas">-</span></div>
      </div>
      <div class="wallet-info" id="walletInfo">Wallet not connected</div>
    </div>

    <div class="card admin-panel" id="adminPanel">
      <h3>Admin Controls</h3>
      <input type="text" id="bidderAddress" placeholder="Enter bidder's wallet address">
      <button id="approveButton" class="btn-primary">Approve Bid</button>
      <button id="rejectButton" class="btn-secondary">Reject Bid</button>
    </div>
  </main>

  <script>
    // Initialize 3D background
    VANTA.NET({
      el: "#bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: 0x00ff00,
      backgroundColor: 0x0,
      points: 12.00,
      maxDistance: 22.00,
      spacing: 18.00
    });

    // Smart contract configuration
    const config = {
      contractAddress: "0xc66cccf6cf6b3e8fe8e489fbbbcd0f81e2ebccd2",
      abi: [
        {"inputs":[{"internalType":"string","name":"uri","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},
        {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ERC1155InsufficientBalance","type":"error"},
        {"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC1155InvalidApprover","type":"error"},
        {"inputs":[{"internalType":"uint256","name":"idsLength","type":"uint256"},{"internalType":"uint256","name":"valuesLength","type":"uint256"}],"name":"ERC1155InvalidArrayLength","type":"error"},
        {"inputs":[{"internalType":"address","name":"operator","type":"address"}],"name":"ERC1155InvalidOperator","type":"error"},
        {"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC1155InvalidReceiver","type":"error"},
        {"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC1155InvalidSender","type":"error"},
        {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"address","name":"owner","type":"address"}],"name":"ERC1155MissingApprovalForAll","type":"error"},
        {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},
        {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"}],"name":"BidApproved","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"BidRejected","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidSubmitted","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"minter","type":"address"}],"name":"NFTMinted","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundIssued","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"TransferBatch","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferSingle","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"value","type":"string"},{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"}],"name":"URI","type":"event"},
        {"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"TOKEN_ID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"approveBid","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address[]","name":"accounts","type":"address[]"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"}],"name":"balanceOfBatch","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bids","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"approved","type":"bool"},{"internalType":"bool","name":"refunded","type":"bool"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasMinted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"rejectBid","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"values","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"submitBid","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"totalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"uri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdrawBid","outputs":[],"stateMutability":"nonpayable","type":"function"}
      ]
    };

    // App state
    let web3;
    let contract;
    let accounts = [];
    let tokenId = 0;
    let isProcessing = false;

    // Initialize the app
    async function initApp() {
      try {
        // Check for Web3 wallet
        if (!window.ethereum) {
          showError("Please install MetaMask or another Web3 wallet.");
          disableButtons();
          return;
        }

        // Initialize Web3
        web3 = new Web3(window.ethereum);
        
        // Check and switch to Polygon network
        await checkNetwork();
        
        // Connect to wallet
        await connectWallet();
        
        // Initialize contract
        contract = new web3.eth.Contract(config.abi, config.contractAddress);
        tokenId = await contract.methods.TOKEN_ID().call();
        
        // Set up UI
        updateWalletInfo();
        await checkOwner();
        await updateStats();
        await checkBidStatus();
        await checkMintedStatus();

        // Set up event listeners
        setupEventListeners();

      } catch (error) {
        console.error("Initialization error:", error);
        showError("Failed to connect. Please refresh and ensure you're on Polygon network.");
        disableButtons();
      }
    }

    async function checkNetwork() {
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });
      if (chainId !== '0x89') { // Polygon mainnet
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x89' }],
          });
        } catch (error) {
          showError("Please switch to Polygon Network in your wallet");
          throw error;
        }
      }
    }

    async function connectWallet() {
      try {
        accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (accounts.length === 0) {
          throw new Error("No accounts found");
        }
      } catch (error) {
        console.error("Wallet connection error:", error);
        showError("Please connect your wallet to continue");
        throw error;
      }
    }

    function updateWalletInfo() {
      const walletInfo = document.getElementById('walletInfo');
      if (accounts.length > 0) {
        const shortAddress = `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
        walletInfo.textContent = `Connected: ${shortAddress}`;
        walletInfo.style.color = "#00ff99";
      } else {
        walletInfo.textContent = "Wallet not connected";
        walletInfo.style.color = "#ff4444";
      }
    }

    async function updateStats() {
      try {
        const [totalMinted, maxSupply, userBalance] = await Promise.all([
          contract.methods.totalMinted().call(),
          contract.methods.MAX_SUPPLY().call(),
          contract.methods.balanceOf(accounts[0], tokenId).call()
        ]);
        
        document.getElementById('totalMinted').textContent = totalMinted;
        document.getElementById('maxSupply').textContent = maxSupply;
        document.getElementById('userBalance').textContent = userBalance;
      } catch (error) {
        console.error("Failed to update stats:", error);
        showError("Failed to load collection stats");
      }
    }

    async function checkBidStatus() {
      try {
        const bid = await contract.methods.bids(accounts[0]).call();
        const mintButton = document.getElementById('mintButton');
        
        if (bid.amount > 0) {
          if (bid.approved) {
            showSuccess("Your bid has been approved! You can now mint.");
            mintButton.disabled = false;
          } else if (bid.refunded) {
            showError("Your bid was refunded.");
            mintButton.disabled = true;
          } else {
            showSuccess("Bid submitted. Waiting for approval...");
            mintButton.disabled = true;
          }
        } else {
          mintButton.disabled = true;
        }
      } catch (error) {
        console.error("Failed to check bid status:", error);
        showError("Failed to check your bid status");
      }
    }

    async function checkMintedStatus() {
      try {
        const hasMinted = await contract.methods.hasMinted(accounts[0]).call();
        const mintButton = document.getElementById('mintButton');
        
        if (hasMinted) {
          mintButton.disabled = true;
          mintButton.textContent = "Already Minted";
          showSuccess("You've already minted your NFT!");
        }
      } catch (error) {
        console.error("Failed to check minted status:", error);
      }
    }

    async function checkOwner() {
      try {
        const owner = await contract.methods.owner().call();
        const adminPanel = document.getElementById('adminPanel');
        
        if (accounts[0] && accounts[0].toLowerCase() === owner.toLowerCase()) {
          adminPanel.style.display = 'block';
          showSuccess("Admin privileges activated");
        } else {
          adminPanel.style.display = 'none';
        }
      } catch (error) {
        console.error("Failed to check owner status:", error);
      }
    }

    // Transaction functions
    async function submitBid() {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const bidAmount = document.getElementById('bidAmount').value;
        if (!bidAmount || isNaN(bidAmount) || parseFloat(bidAmount) <= 0) {
          showError("Please enter a valid positive amount");
          return;
        }

        showLoading();
        hideMessages();
        
        const weiAmount = web3.utils.toWei(bidAmount, "ether");
        
        // Estimate gas first
        const gasEstimate = await contract.methods.submitBid()
          .estimateGas({ from: accounts[0], value: weiAmount });
        
        // Send transaction with 20% gas buffer
        const tx = await contract.methods.submitBid().send({
          from: accounts[0],
          value: weiAmount,
          gas: Math.round(gasEstimate * 1.2)
        });
        
        updateTransactionDetails(tx);
        showSuccess("✅ Bid submitted successfully!");
        await checkBidStatus();
      } catch (err) {
        console.error("Bid submission failed:", err);
        showError(getErrorMessage(err));
      } finally {
        isProcessing = false;
        hideLoading();
      }
    }

    async function mintNFT() {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        showLoading();
        hideMessages();
        
        const gasEstimate = await contract.methods.mint()
          .estimateGas({ from: accounts[0] });
        
        const tx = await contract.methods.mint().send({ 
          from: accounts[0],
          gas: Math.round(gasEstimate * 1.2)
        });
        
        updateTransactionDetails(tx);
        showSuccess("🎉 NFT Minted Successfully!");
        await updateStats();
        await checkMintedStatus();
      } catch (err) {
        console.error("Minting failed:", err);
        showError(getErrorMessage(err));
      } finally {
        isProcessing = false;
        hideLoading();
      }
    }

    async function withdrawBid() {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        showLoading();
        hideMessages();
        
        const gasEstimate = await contract.methods.withdrawBid()
          .estimateGas({ from: accounts[0] });
        
        const tx = await contract.methods.withdrawBid().send({ 
          from: accounts[0],
          gas: Math.round(gasEstimate * 1.2)
        });
        
        updateTransactionDetails(tx);
        showSuccess("✅ Bid withdrawn successfully.");
        await checkBidStatus();
      } catch (err) {
        console.error("Withdrawal failed:", err);
        showError(getErrorMessage(err));
      } finally {
        isProcessing = false;
        hideLoading();
      }
    }

    // Admin functions
    async function approveBid() {
      if (isProcessing) return;
      isProcessing = true;
      
      const bidderAddress = document.getElementById('bidderAddress').value.trim();
      if (!web3.utils.isAddress(bidderAddress)) {
        showError("Please enter a valid wallet address");
        isProcessing = false;
        return;
      }
      
      try {
        showLoading();
        hideMessages();
        
        const gasEstimate = await contract.methods.approveBid(bidderAddress)
          .estimateGas({ from: accounts[0] });
        
        const tx = await contract.methods.approveBid(bidderAddress).send({
          from: accounts[0],
          gas: Math.round(gasEstimate * 1.2)
        });
        
        updateTransactionDetails(tx);
        showSuccess(`✅ Approved bid for ${bidderAddress.substring(0, 6)}...`);
      } catch (err) {
        console.error("Approval failed:", err);
        showError(getErrorMessage(err));
      } finally {
        isProcessing = false;
        hideLoading();
      }
    }

    async function rejectBid() {
      if (isProcessing) return;
      isProcessing = true;
      
      const bidderAddress = document.getElementById('bidderAddress').value.trim();
      if (!web3.utils.isAddress(bidderAddress)) {
        showError("Please enter a valid wallet address");
        isProcessing = false;
        return;
      }
      
      try {
        showLoading();
        hideMessages();
        
        const gasEstimate = await contract.methods.rejectBid(bidderAddress)
          .estimateGas({ from: accounts[0] });
        
        const tx = await contract.methods.rejectBid(bidderAddress).send({
          from: accounts[0],
          gas: Math.round(gasEstimate * 1.2)
        });
        
        updateTransactionDetails(tx);
        showSuccess(`✅ Rejected bid for ${bidderAddress.substring(0, 6)}...`);
      } catch (err) {
        console.error("Rejection failed:", err);
        showError(getErrorMessage(err));
      } finally {
        isProcessing = false;
        hideLoading();
      }
    }

    // Helper functions
    function setupEventListeners() {
      document.getElementById('bidButton').addEventListener('click', submitBid);
      document.getElementById('mintButton').addEventListener('click', mintNFT);
      document.getElementById('withdrawButton').addEventListener('click', withdrawBid);
      document.getElementById('approveButton').addEventListener('click', approveBid);
      document.getElementById('rejectButton').addEventListener('click', rejectBid);
      
      window.ethereum.on('accountsChanged', (newAccounts) => {
        accounts = newAccounts;
        updateWalletInfo();
        updateStats();
        checkBidStatus();
        checkMintedStatus();
        checkOwner();
      });
      
      window.ethereum.on('chainChanged', () => window.location.reload());
    }

    function updateTransactionDetails(tx) {
      document.getElementById('txFrom').textContent = shortenAddress(tx.from);
      document.getElementById('txTo').textContent = shortenAddress(tx.to);
      document.getElementById('txGas').textContent = `${web3.utils.fromWei(tx.gasUsed, 'ether')} MATIC`;
    }

    function shortenAddress(address) {
      if (!address) return '-';
      return `${address.substring(0, 6)}...${address.substring(38)}`;
    }

    function getErrorMessage(error) {
      if (error.code === 4001) return "Transaction was rejected by user";
      if (error.message.includes("Internal JSON-RPC")) return "Network error - please try again";
      if (error.data?.message) {
        const revertMatch = error.data.message.match(/reverted with reason string '(.+)'/);
        if (revertMatch) return revertMatch[1];
      }
      if (error.message.includes("insufficient funds")) return "Insufficient MATIC for transaction";
      return "Transaction failed. See console for details.";
    }

    function showLoading() {
      document.getElementById('loading').style.display = "block";
      disableButtons();
    }

    function hideLoading() {
      document.getElementById('loading').style.display = "none";
      enableButtons();
    }

    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.style.display = "block";
      document.getElementById('success').style.display = "none";
    }

    function showSuccess(message) {
      const el = document.getElementById('success');
      el.textContent = message;
      el.style.display = "block";
      document.getElementById('error').style.display = "none";
    }

    function hideMessages() {
      document.getElementById('error').style.display = "none";
      document.getElementById('success').style.display = "none";
    }

    function disableButtons() {
      document.getElementById('bidButton').disabled = true;
      document.getElementById('mintButton').disabled = true;
      document.getElementById('withdrawButton').disabled = true;
      document.getElementById('approveButton').disabled = true;
      document.getElementById('rejectButton').disabled = true;
    }

    function enableButtons() {
      document.getElementById('bidButton').disabled = false;
      document.getElementById('withdrawButton').disabled = false;
      document.getElementById('approveButton').disabled = false;
      document.getElementById('rejectButton').disabled = false;
    }

    // Initialize the app
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
